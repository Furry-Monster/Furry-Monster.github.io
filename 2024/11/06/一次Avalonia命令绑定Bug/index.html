<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>一次Avalonia命令绑定Bug - Furry Monster的博客</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="一次Avalonia命令绑定Bug - Furry Monster的博客" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://furry-monster.github.io/2024/11/06/%E4%B8%80%E6%AC%A1Avalonia%E5%91%BD%E4%BB%A4%E7%BB%91%E5%AE%9ABug/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-11-06T03:55:41.000Z" />
  
  <meta property="og:article:author" content="FurryMonster" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>
    <body
        data-color-scheme="dark"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/projects">Projects</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/Furry-Monster" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/Alvin-Young-FurryMonster" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://patreon.com/FurryMonster" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="/" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discordapp.com/users/1314183151353987094" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        

        
        <div class="date" id="date">
            <span>November</span>
            <span>6,</span>
            <span>2024</span>
        </div>
        

        <h1 class="title">一次Avalonia命令绑定Bug</h1>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>（<del>Avalonia偶遇Command绑定Bug，越过单例限制报错强如怪物，拼尽全力终于战胜</del>）</p>
<p>算是开发阶段中第一次吃了单例不加锁的亏，前前后后排查了一整天，给群里大佬问红温了都。。。</p>
<p>简单来说，代码最开始是这样的：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">UserControl</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://github.com/avaloniaui&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:d</span>=<span class="string">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:mc</span>=<span class="string">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:vm</span>=<span class="string">&quot;clr-namespace:ItemsPanelMainCommand.ViewModels&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">mc:Ignorable</span>=<span class="string">&quot;d&quot;</span> <span class="attr">d:DesignWidth</span>=<span class="string">&quot;800&quot;</span> <span class="attr">d:DesignHeight</span>=<span class="string">&quot;450&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">x:Class</span>=<span class="string">&quot;ItemsPanelMainCommand.Views.MainView&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">x:DataType</span>=<span class="string">&quot;vm:MainViewModel&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Design.DataContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vm:MainViewModel</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Design.DataContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ItemsControl</span> <span class="attr">ItemsSource</span>=<span class="string">&quot;&#123;Binding Items&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ItemsControl.ItemTemplate</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">DataTemplate</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">StackPanel</span> <span class="attr">Orientation</span>=<span class="string">&quot;Horizontal&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">TextBlock</span> <span class="attr">Text</span>=<span class="string">&quot;&#123;Binding Name&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">TextBlock</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Button</span> <span class="attr">Command</span>=<span class="string">&quot;&#123;Binding DeleteCommand&#125;&quot;</span> <span class="attr">CommandParameter</span>=<span class="string">&quot;&#123;Binding&#125;&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">StackPanel</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">DataTemplate</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ItemsControl.ItemTemplate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ItemsControl</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">UserControl</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>事实上，Button绑定Command的时候，DataContext并不是<strong>MainViewModel</strong>而是<strong>Items</strong>，我们需要找到最外层的DataContext。</p>
<p>一般来说，正常情况会这样解决：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">Command</span>=<span class="string">&quot;&#123;Binding $parent[ItemsControl].DataContext.DeleteCommand&#125;&quot;</span> <span class="attr">x:CompileBindings</span>=<span class="string">&quot;False&quot;</span> <span class="attr">CommandParameter</span>=<span class="string">&quot;&#123;Binding&#125;&quot;</span>&gt;</span>删除-方案1<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">Command</span>=<span class="string">&quot;&#123;ReflectionBinding $parent[ItemsControl].DataContext.DeleteCommand&#125;&quot;</span> <span class="attr">CommandParameter</span>=<span class="string">&quot;&#123;Binding&#125;&quot;</span>&gt;</span>删除-方案2<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">Command</span>=<span class="string">&quot;&#123;Binding $parent[ItemsControl].((vm:MainViewModel)DataContext).DeleteCommand &#125;&quot;</span> <span class="attr">CommandParameter</span>=<span class="string">&quot;&#123;Binding&#125;&quot;</span>&gt;</span>删除-方案3<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者这样解决：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">Command</span>=<span class="string">&quot;&#123;Binding RelativeSource=&#123;RelativeSource AncestorType=UserControl&#125;,Path=DataContext.OpenDesktopCommand&#125;&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>但是这次我干了点不一样的，因为之前学习大佬源码的时候，发现可以用一个ViewModelLocator手动进行ViewModel的管理，所以我就自己手搓了一个VMLocator：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ReactiveUI;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SharpDesktop.ViewModels</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ViewModelLocator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 单例模式</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ViewModelLocator? _instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ViewModelLocator Instance =&gt; _instance ??= <span class="keyword">new</span> ViewModelLocator();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewModelLocator</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _instance = <span class="keyword">this</span>;</span><br><span class="line">        _dic = <span class="keyword">new</span> Dictionary&lt;Type, ViewModelBase?&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> 操作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;hostScreen&quot;&gt;</span> 宿主屏幕 <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span> ViewModelLocator 实例 <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewModelLocator <span class="title">Init</span>(<span class="params">IScreen hostScreen</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _hostScreen = hostScreen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册路由视图模型</span></span><br><span class="line">        Instance.RegisterRoutable&lt;DesktopViewModel&gt;(hostScreen)</span><br><span class="line">                .RegisterRoutable&lt;ResourceViewModel&gt;(hostScreen)</span><br><span class="line">                .RegisterRoutable&lt;WorkspaceViewModel&gt;(hostScreen)</span><br><span class="line">                .RegisterRoutable&lt;ToolboxViewModel&gt;(hostScreen)</span><br><span class="line">                .RegisterRoutable&lt;TerminalViewModel&gt;(hostScreen)</span><br><span class="line">                .RegisterRoutable&lt;AiViewModel&gt;(hostScreen);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册视图模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TViewModel&quot;&gt;</span> 视图模型类型 <span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TConcrete&quot;&gt;</span> 视图模型的实例 <span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewModelLocator <span class="title">Register</span>&lt;<span class="title">TViewModel</span>, <span class="title">TConcrete</span>&gt;() <span class="keyword">where</span> TViewModel : ViewModelBase <span class="keyword">where</span> TConcrete : TViewModel</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> viewModelInstance = Activator.CreateInstance&lt;TConcrete&gt;();</span><br><span class="line">        _dic[<span class="keyword">typeof</span>(TViewModel)] = viewModelInstance ?? <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;无法创建类型 <span class="subst">&#123;<span class="keyword">typeof</span>(TViewModel).Name&#125;</span> 的实例&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>  注册可路由的视图模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TViewModel&quot;&gt;</span> 视图模型类型 <span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;hostScreen&quot;&gt;</span> 宿主屏幕 <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewModelLocator <span class="title">RegisterRoutable</span>&lt;<span class="title">TViewModel</span>&gt;(<span class="params">IScreen hostScreen</span>) <span class="keyword">where</span> TViewModel : ViewModelBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (hostScreen <span class="keyword">is</span> <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(hostScreen));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用反射创建 TViewModel 的实例</span></span><br><span class="line">        <span class="keyword">var</span> viewModelInstance = Activator.CreateInstance(<span class="keyword">typeof</span>(TViewModel), hostScreen) <span class="keyword">as</span> TViewModel;</span><br><span class="line">        _dic[<span class="keyword">typeof</span>(TViewModel)] = viewModelInstance ?? <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;无法创建类型 <span class="subst">&#123;<span class="keyword">typeof</span>(TViewModel).Name&#125;</span> 的实例&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取视图模型实例</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TViewModel&quot;&gt;</span> 视图模型类型 <span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span> 视图模型实例 <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span> 未注册视图模型 <span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TViewModel <span class="title">GetInstance</span>&lt;<span class="title">TViewModel</span>&gt;() <span class="keyword">where</span> TViewModel : ViewModelBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_dic.TryGetValue(<span class="keyword">typeof</span>(TViewModel), <span class="keyword">out</span> <span class="keyword">var</span> vm))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (TViewModel)vm!;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">$&quot;未注册<span class="subst">&#123;<span class="keyword">typeof</span>(TViewModel).Name&#125;</span>的视图模型&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 判断是否注册了视图模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TViewModel&quot;&gt;</span> 视图模型类型 <span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span> 是否注册了视图模型 <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsRegistered</span>&lt;<span class="title">TViewModel</span>&gt;() <span class="keyword">where</span> TViewModel : ViewModelBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _dic.ContainsKey(<span class="keyword">typeof</span>(TViewModel));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注销视图模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TViewModel&quot;&gt;</span> 视图模型类型 <span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewModelLocator <span class="title">Unregister</span>&lt;<span class="title">TViewModel</span>&gt;() <span class="keyword">where</span> TViewModel : ViewModelBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        _dic.Remove(<span class="keyword">typeof</span>(TViewModel));</span><br><span class="line">        <span class="keyword">return</span> Instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 清空所有视图模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewModelLocator <span class="title">Clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _dic.Clear();</span><br><span class="line">        <span class="keyword">return</span> Instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 尝试获取视图模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span> 视图模型类型 <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;vm&quot;&gt;</span> 视图模型实例 <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span> 是否获取成功 <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">TryGetViewModel</span>(<span class="params">Type type, <span class="keyword">out</span> ViewModelBase? vm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _dic.TryGetValue(type, <span class="keyword">out</span> vm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 尝试获取视图模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TViewModel&quot;&gt;</span> 视图模型类型 <span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;vm&quot;&gt;</span> 视图模型实例 <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span> 是否获取成功 <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">TryGetViewModel</span>&lt;<span class="title">TViewModel</span>&gt;(<span class="params"><span class="keyword">out</span> TViewModel? vm</span>) <span class="keyword">where</span> TViewModel : ViewModelBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_dic.TryGetValue(<span class="keyword">typeof</span>(TViewModel), <span class="keyword">out</span> <span class="keyword">var</span> v))</span><br><span class="line">        &#123;</span><br><span class="line">            vm = (TViewModel)v!;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vm = <span class="literal">default</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 尝试获取视图模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TViewModel&quot;&gt;</span> 视图模型类型 <span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;vm&quot;&gt;</span> 视图模型实例 <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span> 是否获取成功 <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">TryGetViewModel</span>&lt;<span class="title">TViewModel</span>&gt;(<span class="params"><span class="keyword">out</span> ViewModelBase? vm</span>) <span class="keyword">where</span> TViewModel : ViewModelBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_dic.TryGetValue(<span class="keyword">typeof</span>(TViewModel), <span class="keyword">out</span> <span class="keyword">var</span> v))</span><br><span class="line">        &#123;</span><br><span class="line">            vm = v;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vm = <span class="literal">default</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 属性与字段</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从类型到视图实例的字典</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Dictionary&lt;Type, ViewModelBase?&gt; _dic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 宿主屏幕</span></span><br><span class="line">    <span class="keyword">private</span> IScreen? _hostScreen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IScreen HostScreen</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> =&gt; _hostScreen ?? <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;未设置HostScreen&quot;</span>);</span><br><span class="line">        <span class="keyword">set</span> =&gt; _hostScreen = <span class="keyword">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内置注册的视图模型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DesktopViewModel DesktopViewModel =&gt; <span class="keyword">this</span>.GetInstance&lt;DesktopViewModel&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResourceViewModel ResourceViewModel =&gt; <span class="keyword">this</span>.GetInstance&lt;ResourceViewModel&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> WorkspaceViewModel WorkspaceViewModel =&gt; <span class="keyword">this</span>.GetInstance&lt;WorkspaceViewModel&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ToolboxViewModel ToolboxViewModel =&gt; <span class="keyword">this</span>.GetInstance&lt;ToolboxViewModel&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TerminalViewModel TerminalViewModel =&gt; <span class="keyword">this</span>.GetInstance&lt;TerminalViewModel&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AiViewModel AiViewModel =&gt; <span class="keyword">this</span>.GetInstance&lt;AiViewModel&gt;();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这不写还好，一写就开始出Bug了。</p>
<p>我在BackCode和View中都注册了这个ViewModelLocator：</p>
<p>App.axaml.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册ViewModelLocator</span></span><br><span class="line">ViewModelLocator.Instance.Init(state);</span><br></pre></td></tr></table></figure>

<p>App.axaml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Application.Resources</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ResourceDictionary</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">vm:ViewModelLocator</span> <span class="attr">x:Key</span>=<span class="string">&quot;VmLocator&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">ResourceDictionary</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Application.Resources</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后当我用Source绑定的时候，直接报错了…</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Command=&quot;&#123;Binding Source=&#123;StaticResource VmLocator&#125;,Path=DesktopViewModel.OpenDesktopCommand&#125;&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>C:\Users\Hanser no maoguai\source\repos\SharpDesktop\SharpDesktop\Views&#x2F;DesktopView.axaml(43,19,43,19): Avalonia error AVLN2000: Unable to resolve property or method of name ‘DesktopViewModel’ on type ‘System.Object’. 第 43 行，位置 19。</p>
</blockquote>
<p>不管我怎么改都编译不了，传入的值总是错误的，遂求助群里大佬，大佬让关掉编译绑定，虽然编译通过了，但是加载这个View仍然会报错，提示无法从空值解析到ViewModel。</p>
<p>原因其实很简单。。。因为Avalonia的App中，BackCode和View各自注册了一个ViewModelLocator。。。我在断点调试时候发现，加载View的时候，ViewModelLocator调用了两次 <code>GetInstance&lt;ViewModel&gt;()</code>，第一次的TryGet有结果是True，第二次却是False，监视VM发现。。。这俩根本就不是一个单例。。。</p>
<p>至于为啥能创建两个单例，我也没深究，可能是我没加线程锁的原因。</p>
<p>最后我还是用RelativeResource解决的绑定问题：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Command=&quot;&#123;Binding RelativeSource=&#123;RelativeSource AncestorType=UserControl&#125;,Path=DataContext.OpenDesktopCommand&#125;&quot;</span><br></pre></td></tr></table></figure>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by FurryMonster, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/NET/" class="tag">#.NET</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/11/16/%E6%B5%85%E6%9E%90%E5%9B%BE%E5%BD%A2%E6%B8%B2%E6%9F%93%E7%A9%BA%E9%97%B4/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">浅析图形渲染空间</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/10/31/%E9%80%9A%E8%BF%87EF%E5%9C%A8Avalonia%E4%B8%AD%E6%93%8D%E4%BD%9CSqlite/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">通过EF在Avalonia中操作Sqlite</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/resume" class="item">Resume</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Mx421Q7yE" class="item">ZenlessZone3C</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/Furry-Monster/YouOnlyLockOncev1.0" class="item">YouOnlyLockOnce</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/Furry-Monster/SharpDesktop" class="item">SharpDesktop</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/Furry-Monster" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/Alvin-Young-FurryMonster" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://patreon.com/FurryMonster" class="item">Patreon</a>
                
                <a href="" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discordapp.com/users/1314183151353987094" class="item">Discord</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 FurryMonster<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>